#!/usr/bin/env python3
"""
üîß PixelPure Windows .exe Builder
==============================
Script t·ª± ƒë·ªông ƒë·ªÉ build PixelPure th√†nh file .exe cho Windows

T√°c gi·∫£: TNI Tech Solutions
Ng√†y t·∫°o: August 2025
"""

import os
import sys
import subprocess
import shutil
from pathlib import Path

# ANSI Colors for console output
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def print_step(message):
    """In b∆∞·ªõc hi·ªán t·∫°i v·ªõi m√†u"""
    print(f"{Colors.OKCYAN}üîß {message}{Colors.ENDC}")

def print_success(message):
    """In th√¥ng b√°o th√†nh c√¥ng"""
    print(f"{Colors.OKGREEN}‚úÖ {message}{Colors.ENDC}")

def print_error(message):
    """In th√¥ng b√°o l·ªói"""
    print(f"{Colors.FAIL}‚ùå {message}{Colors.ENDC}")

def print_warning(message):
    """In c·∫£nh b√°o"""
    print(f"{Colors.WARNING}‚ö†Ô∏è  {message}{Colors.ENDC}")

def check_requirements():
    """Ki·ªÉm tra y√™u c·∫ßu h·ªá th·ªëng"""
    print_step("Ki·ªÉm tra y√™u c·∫ßu h·ªá th·ªëng...")
    
    # Ki·ªÉm tra Python version
    if sys.version_info < (3, 12):
        print_error(f"C·∫ßn Python 3.12+. Hi·ªán t·∫°i: {sys.version}")
        return False
    
    # Ki·ªÉm tra PyInstaller
    try:
        import PyInstaller
        print_success(f"PyInstaller ƒë√£ c√†i ƒë·∫∑t: {PyInstaller.__version__}")
    except ImportError:
        print_warning("PyInstaller ch∆∞a c√†i ƒë·∫∑t. ƒêang c√†i ƒë·∫∑t...")
        subprocess.run([sys.executable, "-m", "pip", "install", "pyinstaller"], check=True)
        print_success("PyInstaller ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t")
    
    # Ki·ªÉm tra PySide6
    try:
        import PySide6
        print_success(f"PySide6 ƒë√£ c√†i ƒë·∫∑t: {PySide6.__version__}")
    except ImportError:
        print_error("PySide6 ch∆∞a c√†i ƒë·∫∑t!")
        print_warning("ƒêang c√†i ƒë·∫∑t PySide6...")
        subprocess.run([sys.executable, "-m", "pip", "install", "PySide6"], check=True)
        print_success("PySide6 ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t")
    
    # Ki·ªÉm tra c√°c dependencies quan tr·ªçng
    required_packages = [
        'torch', 'torchvision', 'open_clip_torch', 
        'PIL', 'cv2', 'numpy', 'imagehash', 'send2trash'
    ]
    
    missing_packages = []
    for package in required_packages:
        try:
            if package == 'PIL':
                import PIL
            elif package == 'cv2':
                import cv2
            elif package == 'open_clip_torch':
                import open_clip
            else:
                __import__(package)
            print_success(f"  ‚úÖ {package}")
        except ImportError:
            missing_packages.append(package)
            print_warning(f"  ‚ö†Ô∏è  {package} - missing")
    
    if missing_packages:
        print_warning(f"Thi·∫øu {len(missing_packages)} packages. ƒêang c√†i ƒë·∫∑t...")
        for package in missing_packages:
            if package == 'open_clip_torch':
                subprocess.run([sys.executable, "-m", "pip", "install", "open-clip-torch"], check=True)
            elif package == 'PIL':
                subprocess.run([sys.executable, "-m", "pip", "install", "Pillow"], check=True)
            elif package == 'cv2':
                subprocess.run([sys.executable, "-m", "pip", "install", "opencv-python"], check=True)
            else:
                subprocess.run([sys.executable, "-m", "pip", "install", package], check=True)
        print_success("T·∫•t c·∫£ dependencies ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t")
    
    return True

def create_build_directory():
    """T·∫°o th∆∞ m·ª•c build"""
    print_step("T·∫°o th∆∞ m·ª•c build...")
    
    build_dir = Path("build_exe")
    dist_dir = Path("dist")
    
    # X√≥a th∆∞ m·ª•c c≈© n·∫øu t·ªìn t·∫°i
    if build_dir.exists():
        shutil.rmtree(build_dir)
    if dist_dir.exists():
        shutil.rmtree(dist_dir)
    
    build_dir.mkdir(exist_ok=True)
    print_success("Th∆∞ m·ª•c build ƒë√£ ƒë∆∞·ª£c t·∫°o")

def create_spec_file():
    """T·∫°o file .spec cho PyInstaller"""
    print_step("T·∫°o file .spec...")
    
    spec_content = '''# -*- mode: python ; coding: utf-8 -*-

import sys
from pathlib import Path
import PySide6

# ƒê∆∞·ªùng d·∫´n project
project_path = Path.cwd()
pyside6_path = Path(PySide6.__file__).parent

a = Analysis(
    ['main.py'],
    pathex=[str(project_path)],
    binaries=[
        # Include PySide6 binaries explicitly
        (str(pyside6_path / "*.dll"), "PySide6"),
        (str(pyside6_path / "*.pyd"), "PySide6"),
    ],
    datas=[
        # Include PySide6 data files
        (str(pyside6_path), "PySide6"),
        # Th√™m c√°c file UI
        ('app_ui.py', '.'),
        ('auto_processor.py', '.'),
        ('cache_manager.py', '.'),
        ('improved_ui_components.py', '.'),
        ('result_dashboard.py', '.'),
        ('speed_config.py', '.'),
        ('core', 'core'),
    ],
    hiddenimports=[
        # PySide6 complete imports
        'PySide6',
        'PySide6.QtCore',
        'PySide6.QtGui', 
        'PySide6.QtWidgets',
        'PySide6.QtOpenGL',
        'shiboken6',
        # AI/ML libraries
        'torch',
        'torch.nn',
        'torch.nn.functional',
        'torchvision',
        'torchvision.transforms',
        'open_clip',
        'open_clip.model',
        'open_clip.transform',
        # Image processing
        'PIL',
        'PIL.Image',
        'PIL.ImageTk',
        'cv2',
        'numpy',
        'imagehash',
        # System utilities
        'send2trash',
        'pathlib',
        'json',
        'time',
        'threading',
        'queue',
        'typing',
        'dataclasses',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        'tkinter',
        'matplotlib',
        'jupyter',
        'IPython',
        'pandas',
        'scipy',
        'sklearn',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=None,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=None)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='PixelPure',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,  # No console window
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='icon.ico' if Path('icon.ico').exists() else None,
    version_file='version_info.txt' if Path('version_info.txt').exists() else None,
    # Additional options for better compatibility
    uac_admin=False,
    uac_uiaccess=False,
)

# Create COLLECT for better structure (optional)
coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='PixelPure_dist'
)
'''
    
    with open("PixelPure.spec", "w", encoding="utf-8") as f:
        f.write(spec_content)
    
    print_success("File .spec ƒë√£ ƒë∆∞·ª£c t·∫°o")

def create_version_info():
    """T·∫°o file version info cho .exe"""
    print_step("T·∫°o version info...")
    
    version_info = '''# UTF-8
#
# Version information for PixelPure.exe
#
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=(1,3,0,0),
    prodvers=(1,3,0,0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
    ),
  kids=[
    StringFileInfo(
      [
      StringTable(
        u'040904B0',
        [StringStruct(u'CompanyName', u'TNI Tech Solutions'),
        StringStruct(u'FileDescription', u'PixelPure - AI-Powered Image Analysis Tool'),
        StringStruct(u'FileVersion', u'1.3.0.0'),
        StringStruct(u'InternalName', u'PixelPure'),
        StringStruct(u'LegalCopyright', u'Copyright ¬© 2025 TNI Tech Solutions'),
        StringStruct(u'OriginalFilename', u'PixelPure.exe'),
        StringStruct(u'ProductName', u'PixelPure'),
        StringStruct(u'ProductVersion', u'1.3.0.0')])
      ]), 
    VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
  ]
)
'''
    
    with open("version_info.txt", "w", encoding="utf-8") as f:
        f.write(version_info)
    
    print_success("Version info ƒë√£ ƒë∆∞·ª£c t·∫°o")

def build_exe():
    """Build file .exe"""
    print_step("B·∫Øt ƒë·∫ßu build file .exe...")
    print_warning("Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 10-15 ph√∫t...")
    
    # Build v·ªõi PyInstaller
    cmd = [
        "pyinstaller",
        "--clean",
        "--noconfirm", 
        "PixelPure.spec"
    ]
    
    try:
        result = subprocess.run(cmd, check=True, capture_output=True, text=True)
        print_success("Build th√†nh c√¥ng!")
        return True
    except subprocess.CalledProcessError as e:
        print_error(f"Build th·∫•t b·∫°i: {e}")
        print(f"Output: {e.stdout}")
        print(f"Error: {e.stderr}")
        return False

def create_installer():
    """T·∫°o installer script"""
    print_step("T·∫°o installer script...")
    
    installer_content = '''@echo off
echo.
echo ===============================================
echo    PixelPure v1.3 - Windows Installer
echo    TNI Tech Solutions - August 2025
echo ===============================================
echo.

echo üîß ƒêang c√†i ƒë·∫∑t PixelPure...

REM T·∫°o th∆∞ m·ª•c c√†i ƒë·∫∑t
set INSTALL_DIR=C:\\Program Files\\PixelPure
if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"

REM Copy files
echo üìÅ Copying files...
xcopy /E /I /Y "dist\\PixelPure.exe" "%INSTALL_DIR%\\"

REM T·∫°o shortcut tr√™n Desktop
echo üîó T·∫°o shortcut...
set DESKTOP=%USERPROFILE%\\Desktop
echo Set oWS = WScript.CreateObject("WScript.Shell") > CreateShortcut.vbs
echo sLinkFile = "%DESKTOP%\\PixelPure.lnk" >> CreateShortcut.vbs
echo Set oLink = oWS.CreateShortcut(sLinkFile) >> CreateShortcut.vbs
echo oLink.TargetPath = "%INSTALL_DIR%\\PixelPure.exe" >> CreateShortcut.vbs
echo oLink.Save >> CreateShortcut.vbs
cscript CreateShortcut.vbs
del CreateShortcut.vbs

echo.
echo ‚úÖ C√†i ƒë·∫∑t ho√†n t·∫•t!
echo üöÄ B·∫°n c√≥ th·ªÉ ch·∫°y PixelPure t·ª´ Desktop ho·∫∑c:
echo    %INSTALL_DIR%\\PixelPure.exe
echo.
pause
'''
    
    with open("installer.bat", "w", encoding="utf-8") as f:
        f.write(installer_content)
    
    print_success("Installer script ƒë√£ ƒë∆∞·ª£c t·∫°o")

def create_readme_exe():
    """T·∫°o README cho b·∫£n .exe"""
    print_step("T·∫°o README cho b·∫£n .exe...")
    
    readme_content = '''# üñºÔ∏è PixelPure v1.3 - Windows Executable

## üì¶ H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t

### **Ph∆∞∆°ng ph√°p 1: Ch·∫°y tr·ª±c ti·∫øp (Khuy·∫øn ngh·ªã)**
1. T·∫£i file `PixelPure.exe` t·ª´ th∆∞ m·ª•c `dist/`
2. Double-click ƒë·ªÉ ch·∫°y ngay l·∫≠p t·ª©c
3. Kh√¥ng c·∫ßn c√†i ƒë·∫∑t Python hay dependencies

### **Ph∆∞∆°ng ph√°p 2: C√†i ƒë·∫∑t v√†o h·ªá th·ªëng**
1. Ch·∫°y `installer.bat` v·ªõi quy·ªÅn Administrator
2. PixelPure s·∫Ω ƒë∆∞·ª£c c√†i v√†o `C:\\Program Files\\PixelPure\\`
3. Shortcut s·∫Ω ƒë∆∞·ª£c t·∫°o tr√™n Desktop

## üìã Y√™u c·∫ßu h·ªá th·ªëng
- **OS:** Windows 10/11 (64-bit)
- **RAM:** 4GB+ (8GB khuy·∫øn ngh·ªã)
- **Storage:** 2GB+ dung l∆∞·ª£ng tr·ªëng
- **Internet:** C·∫ßn k·∫øt n·ªëi cho l·∫ßn ƒë·∫ßu t·∫£i AI models

## ‚ö° T√≠nh nƒÉng
- ‚úÖ **Portable:** Ch·∫°y m√† kh√¥ng c·∫ßn c√†i ƒë·∫∑t Python
- ‚úÖ **Self-contained:** T·∫•t c·∫£ dependencies ƒë√£ ƒë∆∞·ª£c ƒë√≥ng g√≥i
- ‚úÖ **AI-Powered:** CLIP model t·ª± ƒë·ªông t·∫£i v·ªÅ khi c·∫ßn
- ‚úÖ **User-friendly:** Giao di·ªán ƒë∆°n gi·∫£n, d·ªÖ s·ª≠ d·ª•ng

## üöÄ C√°ch s·ª≠ d·ª•ng
1. Ch·∫°y `PixelPure.exe`
2. Drag & drop ·∫£nh v√†o ·ª©ng d·ª•ng
3. Nh·∫•n "B·∫Øt ƒë·∫ßu qu√©t"
4. Xem k·∫øt qu·∫£ v√† x·ª≠ l√Ω t·ª± ƒë·ªông

## üìû H·ªó tr·ª£
- **GitHub:** https://github.com/tech-tnitechsolve/Pixelpure_subject
- **Email:** support@tnitechsolve.com

---
**Made with ‚ù§Ô∏è by TNI Tech Solutions**
'''
    
    with open("README_EXE.md", "w", encoding="utf-8") as f:
        f.write(readme_content)
    
    print_success("README cho b·∫£n .exe ƒë√£ ƒë∆∞·ª£c t·∫°o")

def cleanup():
    """D·ªçn d·∫πp files t·∫°m"""
    print_step("D·ªçn d·∫πp files t·∫°m...")
    
    temp_files = ["PixelPure.spec", "version_info.txt"]
    temp_dirs = ["build", "__pycache__"]
    
    for file in temp_files:
        if Path(file).exists():
            Path(file).unlink()
    
    for dir in temp_dirs:
        if Path(dir).exists():
            shutil.rmtree(dir)
    
    print_success("D·ªçn d·∫πp ho√†n t·∫•t")

def main():
    """Main function"""
    print(f"{Colors.HEADER}")
    print("üîß PixelPure Windows .exe Builder")
    print("=" * 40)
    print("TNI Tech Solutions - August 2025")
    print(f"{Colors.ENDC}")
    
    try:
        # Ki·ªÉm tra y√™u c·∫ßu
        if not check_requirements():
            return
        
        # T·∫°o build directory
        create_build_directory()
        
        # T·∫°o c√°c file c·∫ßn thi·∫øt
        create_spec_file()
        create_version_info()
        create_installer()
        create_readme_exe()
        
        # Build .exe
        if build_exe():
            print_success("üéâ Build th√†nh c√¥ng!")
            print(f"{Colors.OKGREEN}")
            print("üìÅ Files ƒë√£ ƒë∆∞·ª£c t·∫°o:")
            print("  üìÑ dist/PixelPure.exe       - ·ª®ng d·ª•ng ch√≠nh")
            print("  üìÑ installer.bat           - Script c√†i ƒë·∫∑t") 
            print("  üìÑ README_EXE.md          - H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng")
            print(f"{Colors.ENDC}")
            
            # H·ªèi c√≥ mu·ªën d·ªçn d·∫πp kh√¥ng
            choice = input("\nüîß C√≥ mu·ªën d·ªçn d·∫πp files t·∫°m? (y/n): ").lower()
            if choice in ['y', 'yes']:
                cleanup()
        else:
            print_error("Build th·∫•t b·∫°i!")
            
    except KeyboardInterrupt:
        print_error("\nBuild b·ªã h·ªßy b·ªüi ng∆∞·ªùi d√πng")
    except Exception as e:
        print_error(f"L·ªói kh√¥ng mong mu·ªën: {e}")

if __name__ == "__main__":
    main()
